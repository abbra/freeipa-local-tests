---
- name: Create container image
  run: |
    podman build -t fedora-freeipa:40 -f Containerfile.build.fedora

- name: Create Python environment
  run: |
    python3 -m venv ipa-local-test

- name: Clone and setup mrack
  run: |
    cd ipa-local-test
    source bin/activate
    pip3 install git+https://github.com/abbra/mrack@podman-freeipa

- name: Clone ansible-freeipa repository
  run: |
    cd ipa-local-test
    git clone --depth 1 https://github.com/freeipa/ansible-freeipa.git af

- name: Create test environments as podman containers with mrack
  run: |
    cd ipa-local-test
    source bin/activate
    cp -r ../data .
    cd data
    mrack up -m metadata.yaml

- name: Install IPA cluster for ipa1demo.test
  run: |
    cd ipa-local-test
    source bin/activate
    cd data
    ansible-playbook -i mrack-inventory.yaml -i ipa1demo.hosts \
                     -c podman af/playbooks/install-cluster.yml

- name: Install IPA cluster for ipa2demo.test
  run: |
    cd ipa-local-test
    source bin/activate
    cd data
    ansible-playbook -i mrack-inventory.yaml -i ipa2demo.hosts \
                     -c podman af/playbooks/install-cluster.yml

- name: Establish trust between IPA clusters
  run: |
    cd ipa-local-test
    source bin/activate
    cd data
    ansible-playbook -i mrack-inventory.yaml \
                     -c podman establish-trust.yml


